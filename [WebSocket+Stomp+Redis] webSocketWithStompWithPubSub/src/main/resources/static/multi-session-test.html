<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi WebSocket Session Test (STOMP)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .sessions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .session-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            border: 2px solid #ddd;
        }
        
        .session-card.connected {
            border-color: #28a745;
        }
        
        .session-card.disconnected {
            border-color: #dc3545;
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .session-title {
            font-weight: bold;
            font-size: 16px;
        }
        
        .session-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .session-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .session-controls button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-connect {
            background-color: #28a745;
            color: white;
        }
        
        .btn-disconnect {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-connect:disabled, .btn-disconnect:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .message-area {
            height: 200px;
            border: 1px solid #ddd;
            padding: 8px;
            overflow-y: auto;
            background-color: #f9f9f9;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .message-input-group {
            display: flex;
            gap: 5px;
        }
        
        .message-input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .btn-send {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-send:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .global-controls {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .global-controls h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .global-button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .global-button-group button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .broadcast-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .broadcast-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .stats {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .message {
            margin-bottom: 3px;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .message.sent {
            color: #007bff;
        }
        
        .message.received {
            color: #28a745;
        }
        
        .message.system {
            color: #6c757d;
            font-style: italic;
        }
        
        .message.error {
            color: #dc3545;
        }
        
        .message.scheduled {
            color: #fd7e14;
            font-weight: bold;
            background-color: #fff3cd;
            padding: 5px;
            border-radius: 3px;
        }
        
        .message.heartbeat {
            color: #e91e63;
            font-size: 0.9em;
            font-style: italic;
            background-color: #fce4ec;
            padding: 3px 5px;
            border-radius: 3px;
            opacity: 0.8;
        }
        

    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”— Multi WebSocket Session Test (STOMP)</h1>
        <p>ì—¬ëŸ¬ STOMP WebSocket ì„¸ì…˜ì„ ë™ì‹œì— ê´€ë¦¬í•˜ê³  ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
    </div>
    
    <div class="global-controls">
        <h3>ì „ì—­ ì œì–´</h3>
        <div class="global-button-group">
            <button class="btn-primary" onclick="addSession()">ìƒˆ ì„¸ì…˜ ì¶”ê°€</button>
            <button class="btn-success" onclick="connectAllSessions()">ëª¨ë“  ì„¸ì…˜ ì—°ê²°</button>
            <button class="btn-danger" onclick="disconnectAllSessions()">ëª¨ë“  ì„¸ì…˜ ì—°ê²° í•´ì œ</button>
            <button class="btn-warning" onclick="clearAllMessages()">ëª¨ë“  ë©”ì‹œì§€ ì§€ìš°ê¸°</button>
            <button class="btn-info" onclick="getSessionCount()">ì„¸ì…˜ ìˆ˜ ì¡°íšŒ</button>
        </div>
        
        <div class="broadcast-input-group">
            <input type="text" id="globalBroadcastInput" class="broadcast-input" placeholder="ëª¨ë“  ì„¸ì…˜ì— ë¸Œë¡œë“œìºìŠ¤íŠ¸í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <button class="btn-success" onclick="sendGlobalBroadcast()">ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì „ì†¡</button>
        </div>
        
        <div class="stats" id="globalStats">
            ì´ ì„¸ì…˜: 0ê°œ | ì—°ê²°ëœ ì„¸ì…˜: 0ê°œ | ì—°ê²° í•´ì œëœ ì„¸ì…˜: 0ê°œ
        </div>
    </div>
    
    <div class="sessions-container" id="sessionsContainer">
        <!-- ì„¸ì…˜ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>

    <!-- STOMP.jsì™€ SockJS CDN ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

    <script>
        // ========== ì „ì—­ ë³€ìˆ˜ ë° ì„¸ì…˜ ê´€ë¦¬ ==========
        
        /**
         * ì„¸ì…˜ ì €ì¥ì†Œ - ê° ì„¸ì…˜ì˜ ì •ë³´ë¥¼ ê´€ë¦¬
         * @type {Array<Object>} sessions
         */
        let sessions = [];
        
        /**
         * ì„¸ì…˜ ID ì¹´ìš´í„° - ìƒˆë¡œìš´ ì„¸ì…˜ì— ê³ ìœ  ID ë¶€ì—¬
         * @type {number}
         */
        let sessionIdCounter = 0;

        // ========== ì„¸ì…˜ ìƒì„± ë° ê´€ë¦¬ í•¨ìˆ˜ ==========
        
        /**
         * ìƒˆë¡œìš´ STOMP WebSocket ì„¸ì…˜ì„ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
         */
        function addSession() {
            const sessionId = ++sessionIdCounter;
            
            // ì„¸ì…˜ ê°ì²´ ìƒì„±
            const session = {
                id: sessionId,
                stompClient: null,
                connected: false,
                messageCount: 0
            };
            
            // ì„¸ì…˜ ë°°ì—´ì— ì¶”ê°€
            sessions.push(session);
            
            // UIì— ì„¸ì…˜ ì¹´ë“œ ìƒì„±
            createSessionCard(session);
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            updateGlobalStats();
            
            console.log(`â• ìƒˆ ì„¸ì…˜ ì¶”ê°€: Session-${sessionId}`);
        }

        /**
         * ì„¸ì…˜ ì¹´ë“œ UIë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
         * @param {Object} session - ì„¸ì…˜ ê°ì²´
         */
        function createSessionCard(session) {
            const container = document.getElementById('sessionsContainer');
            
            const sessionCard = document.createElement('div');
            sessionCard.className = 'session-card disconnected';
            sessionCard.id = `session-${session.id}`;
            
            sessionCard.innerHTML = `
                <div class="session-header">
                    <span class="session-title">Session-${session.id}</span>
                    <span class="session-status status-disconnected" id="status-${session.id}">ì—°ê²° í•´ì œ</span>
                </div>
                
                <div class="session-controls">
                    <button class="btn-connect" onclick="connectSession(${session.id})" id="connect-btn-${session.id}">ì—°ê²°</button>
                    <button class="btn-disconnect" onclick="disconnectSession(${session.id})" id="disconnect-btn-${session.id}" disabled>ì—°ê²° í•´ì œ</button>
                    <button class="btn-danger" onclick="removeSession(${session.id})">ì„¸ì…˜ ì‚­ì œ</button>
                </div>
                
                <div class="message-area" id="messages-${session.id}"></div>
                
                <div class="message-input-group">
                    <input type="text" class="message-input" id="input-${session.id}" placeholder="ë©”ì‹œì§€ ì…ë ¥..." disabled>
                    <button class="btn-send" onclick="sendMessage(${session.id})" id="send-btn-${session.id}" disabled>ì „ì†¡</button>
                </div>
            `;
            
            container.appendChild(sessionCard);
            
            // Enter í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.getElementById(`input-${session.id}`).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage(session.id);
                }
            });
        }

        /**
         * íŠ¹ì • ì„¸ì…˜ì„ STOMPë¡œ ì—°ê²°í•˜ëŠ” í•¨ìˆ˜
         * @param {number} sessionId - ì—°ê²°í•  ì„¸ì…˜ì˜ ID
         */
        function connectSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                console.error(`âŒ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${sessionId}`);
                return;
            }
            
            console.log(`ğŸ”— ì„¸ì…˜ ì—°ê²° ì‹œë„: Session-${sessionId}`);
            
            // SockJS ì†Œì¼“ ìƒì„±
            const socket = new SockJS('/ws');
            
            // STOMP í´ë¼ì´ì–¸íŠ¸ ìƒì„±
            session.stompClient = new StompJs.Client({
                webSocketFactory: () => socket,
                debug: (str) => {
                    console.log(`ğŸ” STOMP Debug [Session-${sessionId}]:`, str);
                },
                onConnect: (frame) => {
                    console.log(`âœ… STOMP ì—°ê²° ì„±ê³µ [Session-${sessionId}]:`, frame);
                    
                    // ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                    session.connected = true;
                    updateSessionUI(sessionId, true);
                    
                    // ì—°ê²° ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    addMessageToSession(sessionId, 'ì‹œìŠ¤í…œ: STOMP ì—°ê²° ì„±ê³µ', 'system');
                    
                    // í† í”½ êµ¬ë… ì„¤ì •
                    subscribeToTopics(sessionId);
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    updateGlobalStats();
                },
                onDisconnect: (frame) => {
                    console.log(`ğŸ”Œ STOMP ì—°ê²° ì¢…ë£Œ [Session-${sessionId}]:`, frame);
                    
                    // ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                    session.connected = false;
                    updateSessionUI(sessionId, false);
                    
                    // ì—°ê²° ì¢…ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                    addMessageToSession(sessionId, 'ì‹œìŠ¤í…œ: STOMP ì—°ê²° ì¢…ë£Œ', 'system');
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    updateGlobalStats();
                },
                onStompError: (frame) => {
                    console.error(`âŒ STOMP ì—ëŸ¬ [Session-${sessionId}]:`, frame);
                    
                    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    addMessageToSession(sessionId, `ì‹œìŠ¤í…œ: STOMP ì˜¤ë¥˜ - ${frame.body}`, 'error');
                }
            });
            
            // STOMP í´ë¼ì´ì–¸íŠ¸ í™œì„±í™”
            session.stompClient.activate();
        }

        /**
         * íŠ¹ì • ì„¸ì…˜ì˜ í† í”½ êµ¬ë…ì„ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
         * @param {number} sessionId - êµ¬ë…ì„ ì„¤ì •í•  ì„¸ì…˜ì˜ ID
         */
        function subscribeToTopics(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session || !session.stompClient || !session.stompClient.connected) {
                console.warn(`âš ï¸ ì„¸ì…˜ êµ¬ë… ì‹¤íŒ¨: Session-${sessionId}`);
                return;
            }
            
            // 1. ì¼ë°˜ ë©”ì‹œì§€ í† í”½ êµ¬ë…
            session.stompClient.subscribe('/topic/messages', (message) => {
                try {
                    const messageData = JSON.parse(message.body);
                    addMessageToSession(sessionId, `ì„œë²„: ${messageData.content}`, 'received');
                } catch (e) {
                    addMessageToSession(sessionId, `ì„œë²„: ${message.body}`, 'received');
                }
            });
            
            // 2. í•˜íŠ¸ë¹„íŠ¸ í† í”½ êµ¬ë…
            session.stompClient.subscribe('/topic/heartbeat', (message) => {
                console.log(`ğŸ’— í•˜íŠ¸ë¹„íŠ¸ [Session-${sessionId}]:`, message.body);
                
                try {
                    const heartbeatData = JSON.parse(message.body);
                    // í•˜íŠ¸ë¹„íŠ¸ ë©”ì‹œì§€ë¥¼ í™”ë©´ì—ë„ í‘œì‹œ
                    const formattedMessage = `ğŸ’— ${heartbeatData.content}`;
                    addMessageToSession(sessionId, formattedMessage, 'heartbeat');
                } catch (e) {
                    // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë©”ì‹œì§€ í‘œì‹œ
                    addMessageToSession(sessionId, `ğŸ’— í•˜íŠ¸ë¹„íŠ¸: ${message.body}`, 'heartbeat');
                }
            });
            
            // 3. ì‹œìŠ¤í…œ ìƒíƒœ í† í”½ êµ¬ë…
            session.stompClient.subscribe('/topic/status', (message) => {
                try {
                    const statusData = JSON.parse(message.body);
                    console.log(`ğŸ” íŒŒì‹±ëœ ì‹œìŠ¤í…œ ìƒíƒœ ë°ì´í„° [Session-${sessionId}]:`, statusData);
                    
                    // STOMP ë©”ì‹œì§€ì—ì„œ extraData í•„ë“œì— ì‹¤ì œ ì‹œìŠ¤í…œ ì •ë³´ê°€ ë“¤ì–´ìˆìŒ
                    // Jacksonì´ extraDataë¥¼ extra_dataë¡œ ì§ë ¬í™”í•  ìˆ˜ ìˆìŒ
                    const systemInfo = statusData.extraData || statusData.extra_data || statusData;
                    
                    const memoryUsage = systemInfo.memory_usage_percent || systemInfo.memoryUsagePercent || 'N/A';
                    const activeSessions = systemInfo.active_sessions || systemInfo.activeSessions || 'N/A';
                    const memoryUsedMb = systemInfo.memory_used_mb || systemInfo.memoryUsedMb || 'N/A';
                    const memoryTotalMb = systemInfo.memory_total_mb || systemInfo.memoryTotalMb || 'N/A';
                    
                    const formattedMessage = `ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ - ë©”ëª¨ë¦¬: ${memoryUsedMb}/${memoryTotalMb}MB (${memoryUsage}%), í™œì„± ì„¸ì…˜: ${activeSessions}ê°œ`;
                    addMessageToSession(sessionId, formattedMessage, 'system');
                } catch (e) {
                    console.error(`âŒ ì‹œìŠ¤í…œ ìƒíƒœ íŒŒì‹± ì˜¤ë¥˜ [Session-${sessionId}]:`, e);
                    addMessageToSession(sessionId, `ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ: ${message.body}`, 'system');
                }
            });
            
            // 4. ì•Œë¦¼ í† í”½ êµ¬ë…
            session.stompClient.subscribe('/topic/notifications', (message) => {
                try {
                    const notificationData = JSON.parse(message.body);
                    const formattedMessage = `ğŸ”” ì•Œë¦¼ [${notificationData.timestamp}] - ${notificationData.content}`;
                    addMessageToSession(sessionId, formattedMessage, 'scheduled');
                } catch (e) {
                    addMessageToSession(sessionId, `ğŸ”” ì•Œë¦¼: ${message.body}`, 'scheduled');
                }
            });
            
            // 5. ì‚¬ìš©ì ê°œì¸ ë©”ì‹œì§€ í† í”½ êµ¬ë…
            session.stompClient.subscribe('/user/queue/messages', (message) => {
                try {
                    const privateData = JSON.parse(message.body);
                    addMessageToSession(sessionId, `ê°œì¸ ë©”ì‹œì§€: ${privateData.content}`, 'received');
                } catch (e) {
                    addMessageToSession(sessionId, `ê°œì¸ ë©”ì‹œì§€: ${message.body}`, 'received');
                }
            });
            
            console.log(`âœ… í† í”½ êµ¬ë… ì™„ë£Œ [Session-${sessionId}]`);
        }

        /**
         * íŠ¹ì • ì„¸ì…˜ì˜ STOMP ì—°ê²°ì„ ì¢…ë£Œí•˜ëŠ” í•¨ìˆ˜
         * @param {number} sessionId - ì—°ê²°ì„ ì¢…ë£Œí•  ì„¸ì…˜ì˜ ID
         */
        function disconnectSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                console.error(`âŒ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${sessionId}`);
                return;
            }
            
            if (session.stompClient && session.stompClient.connected) {
                console.log(`ğŸ”Œ ì„¸ì…˜ ì—°ê²° í•´ì œ: Session-${sessionId}`);
                session.stompClient.deactivate();
            }
        }

        /**
         * íŠ¹ì • ì„¸ì…˜ì—ì„œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
         * @param {number} sessionId - ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ì„¸ì…˜ì˜ ID
         */
        function sendMessage(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                console.error(`âŒ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${sessionId}`);
                return;
            }
            
            const input = document.getElementById(`input-${sessionId}`);
            const message = input.value.trim();
            
            if (message && session.stompClient && session.stompClient.connected) {
                console.log(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡ [Session-${sessionId}]:`, message);
                
                // STOMP ë©”ì‹œì§€ ì „ì†¡
                session.stompClient.publish({
                    destination: '/app/message',
                    body: JSON.stringify({
                        content: message,
                        timestamp: new Date().toISOString()
                    })
                });
                
                // ì „ì†¡í•œ ë©”ì‹œì§€ë¥¼ UIì— í‘œì‹œ
                addMessageToSession(sessionId, `ë‚˜: ${message}`, 'sent');
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                input.value = '';
                
                // ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ì¦ê°€
                session.messageCount++;
            } else {
                console.warn(`âš ï¸ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨ [Session-${sessionId}]: ì—°ê²°ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìŒ`);
            }
        }

        /**
         * íŠ¹ì • ì„¸ì…˜ì„ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
         * @param {number} sessionId - ì‚­ì œí•  ì„¸ì…˜ì˜ ID
         */
        function removeSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                console.error(`âŒ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${sessionId}`);
                return;
            }
            
            // ì—°ê²°ëœ ê²½ìš° ë¨¼ì € ì—°ê²° í•´ì œ
            if (session.connected) {
                disconnectSession(sessionId);
            }
            
            // ì„¸ì…˜ ë°°ì—´ì—ì„œ ì œê±°
            sessions = sessions.filter(s => s.id !== sessionId);
            
            // UIì—ì„œ ì„¸ì…˜ ì¹´ë“œ ì œê±°
            const sessionCard = document.getElementById(`session-${sessionId}`);
            if (sessionCard) {
                sessionCard.remove();
            }
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            updateGlobalStats();
            
            console.log(`ğŸ—‘ï¸ ì„¸ì…˜ ì‚­ì œ: Session-${sessionId}`);
        }

        // ========== UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ==========
        
        /**
         * ì„¸ì…˜ UI ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
         * @param {number} sessionId - ì—…ë°ì´íŠ¸í•  ì„¸ì…˜ì˜ ID
         * @param {boolean} connected - ì—°ê²° ìƒíƒœ
         */
        function updateSessionUI(sessionId, connected) {
            const sessionCard = document.getElementById(`session-${sessionId}`);
            const statusSpan = document.getElementById(`status-${sessionId}`);
            const connectBtn = document.getElementById(`connect-btn-${sessionId}`);
            const disconnectBtn = document.getElementById(`disconnect-btn-${sessionId}`);
            const input = document.getElementById(`input-${sessionId}`);
            const sendBtn = document.getElementById(`send-btn-${sessionId}`);
            
            if (connected) {
                sessionCard.className = 'session-card connected';
                statusSpan.textContent = 'ì—°ê²°ë¨';
                statusSpan.className = 'session-status status-connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                input.disabled = false;
                sendBtn.disabled = false;
            } else {
                sessionCard.className = 'session-card disconnected';
                statusSpan.textContent = 'ì—°ê²° í•´ì œ';
                statusSpan.className = 'session-status status-disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                input.disabled = true;
                sendBtn.disabled = true;
            }
        }

        /**
         * íŠ¹ì • ì„¸ì…˜ì˜ ë©”ì‹œì§€ ì˜ì—­ì— ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
         * @param {number} sessionId - ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•  ì„¸ì…˜ì˜ ID
         * @param {string} message - ë©”ì‹œì§€ ë‚´ìš©
         * @param {string} type - ë©”ì‹œì§€ íƒ€ì…
         */
        function addMessageToSession(sessionId, message, type) {
            const messagesDiv = document.getElementById(`messages-${sessionId}`);
            if (!messagesDiv) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        /**
         * ì „ì—­ í†µê³„ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
         */
        function updateGlobalStats() {
            const totalSessions = sessions.length;
            const connectedSessions = sessions.filter(s => s.connected).length;
            const disconnectedSessions = totalSessions - connectedSessions;
            
            const statsDiv = document.getElementById('globalStats');
            statsDiv.textContent = `ì´ ì„¸ì…˜: ${totalSessions}ê°œ | ì—°ê²°ëœ ì„¸ì…˜: ${connectedSessions}ê°œ | ì—°ê²° í•´ì œëœ ì„¸ì…˜: ${disconnectedSessions}ê°œ`;
        }

        // ========== ì „ì—­ ì œì–´ í•¨ìˆ˜ ==========
        
        /**
         * ëª¨ë“  ì„¸ì…˜ì„ ì—°ê²°í•˜ëŠ” í•¨ìˆ˜
         */
        function connectAllSessions() {
            console.log('ğŸ”— ëª¨ë“  ì„¸ì…˜ ì—°ê²° ì‹œì‘');
            sessions.forEach(session => {
                if (!session.connected) {
                    connectSession(session.id);
                }
            });
        }

        /**
         * ëª¨ë“  ì„¸ì…˜ì˜ ì—°ê²°ì„ í•´ì œí•˜ëŠ” í•¨ìˆ˜
         */
        function disconnectAllSessions() {
            console.log('ğŸ”Œ ëª¨ë“  ì„¸ì…˜ ì—°ê²° í•´ì œ ì‹œì‘');
            sessions.forEach(session => {
                if (session.connected) {
                    disconnectSession(session.id);
                }
            });
        }

        /**
         * ëª¨ë“  ì„¸ì…˜ì˜ ë©”ì‹œì§€ë¥¼ ì§€ìš°ëŠ” í•¨ìˆ˜
         */
        function clearAllMessages() {
            console.log('ğŸ§¹ ëª¨ë“  ë©”ì‹œì§€ ì§€ìš°ê¸°');
            sessions.forEach(session => {
                const messagesDiv = document.getElementById(`messages-${session.id}`);
                if (messagesDiv) {
                    messagesDiv.innerHTML = '';
                }
                session.messageCount = 0;
            });
        }

        /**
         * ì „ì—­ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
         */
        function sendGlobalBroadcast() {
            const input = document.getElementById('globalBroadcastInput');
            const message = input.value.trim();
            
            if (!message) {
                alert('ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            console.log('ğŸ“¡ ì „ì—­ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì „ì†¡:', message);
            
            // ëª¨ë“  ì—°ê²°ëœ ì„¸ì…˜ì—ì„œ ë©”ì‹œì§€ ì „ì†¡
            sessions.forEach(session => {
                if (session.connected && session.stompClient) {
                    session.stompClient.publish({
                        destination: '/app/message',
                        body: JSON.stringify({
                            content: `[ë¸Œë¡œë“œìºìŠ¤íŠ¸] ${message}`,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    addMessageToSession(session.id, `ë‚˜ (ë¸Œë¡œë“œìºìŠ¤íŠ¸): ${message}`, 'sent');
                    session.messageCount++;
                }
            });
            
            input.value = '';
        }

        /**
         * í™œì„± ì„¸ì…˜ ìˆ˜ë¥¼ ì¡°íšŒí•˜ëŠ” REST API í˜¸ì¶œ
         */
        async function getSessionCount() {
            try {
                console.log('ğŸ” API í˜¸ì¶œ: í™œì„± ì„¸ì…˜ ìˆ˜ ì¡°íšŒ');
                
                const response = await fetch('/api/websocket/sessions/count');
                const data = await response.json();
                
                console.log('ğŸ“Š í™œì„± ì„¸ì…˜ ìˆ˜ ì¡°íšŒ ê²°ê³¼:', data);
                
                // ëª¨ë“  ì„¸ì…˜ì— ê²°ê³¼ í‘œì‹œ
                sessions.forEach(session => {
                    addMessageToSession(session.id, `API: ì„œë²„ í™œì„± ì„¸ì…˜ ìˆ˜ - ${data.activeSessionCount}`, 'system');
                });
            } catch (error) {
                console.error('âŒ API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                
                sessions.forEach(session => {
                    addMessageToSession(session.id, `API ì˜¤ë¥˜: ${error.message}`, 'error');
                });
            }
        }

        // ========== ì´ˆê¸°í™” ==========
        
        /**
         * í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì„¸ì…˜ ìƒì„±
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Multi STOMP WebSocket Test í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            
            // ì´ˆê¸° ì„¸ì…˜ 2ê°œ ìƒì„±
            addSession();
            addSession();
            
            // ì „ì—­ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ Enter í‚¤ ì´ë²¤íŠ¸
            document.getElementById('globalBroadcastInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendGlobalBroadcast();
                }
            });
        });
    </script>
</body>
</html> 