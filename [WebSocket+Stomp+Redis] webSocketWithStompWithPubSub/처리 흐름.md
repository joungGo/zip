![img.png](src/main/resources/images/img.png)

ğŸ  **ì‚¬ìš©ì ë£¸ ì…ì¥ ì‹œ ì²˜ë¦¬ íë¦„ ë¶„ì„**

## **ğŸ“‹ ì „ì²´ ì²˜ë¦¬ ê³¼ì • (8ë‹¨ê³„)**

```mermaid
sequenceDiagram
    participant C as í´ë¼ì´ì–¸íŠ¸
    participant SC as STOMP Controller
    participant RS as Room Service
    participant RP as Redis Publisher
    participant Redis as Redis Server
    participant RL as Redis Listener
    participant RSub as Redis Subscriber
    
    C->>SC: 1. /app/room/join ë©”ì‹œì§€ ì „ì†¡
    SC->>RS: 2. ë£¸ ì…ì¥ ì²˜ë¦¬ ìš”ì²­
    RS->>RL: 3. í•´ë‹¹ ë£¸ ì±„ë„ ë™ì  êµ¬ë…
    RS->>RS: 4. ë£¸ ì°¸ì—¬ì ëª©ë¡ ì—…ë°ì´íŠ¸
    RS->>RP: 5. ì…ì¥ ë©”ì‹œì§€ Redis ë°œí–‰
    RP->>Redis: 6. stomp:room:{roomId} ì±„ë„ë¡œ ë°œí–‰
    Redis->>RSub: 7. êµ¬ë… ì¤‘ì¸ ì„œë²„ë“¤ì—ê²Œ ì „íŒŒ
    RSub->>C: 8. /topic/room/{roomId}ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
```

## **ğŸ”„ ë‹¨ê³„ë³„ ìƒì„¸ ë¶„ì„**

### **1ï¸âƒ£ í´ë¼ì´ì–¸íŠ¸ ì…ì¥ ìš”ì²­**
```javascript
// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë£¸ ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
stompClient.send("/app/room/join", {}, JSON.stringify({
    roomId: "room1",
    username: "ì‚¬ìš©ìA"
}));
```

### **2ï¸âƒ£ STOMP Controller ìˆ˜ì‹  (êµ¬í˜„ ì˜ˆì •)**
```java
@MessageMapping("/room/join")
public void handleRoomJoin(@Payload JoinRoomRequest request, 
                          SimpMessageHeaderAccessor headerAccessor) {
    // Phase 3ì—ì„œ êµ¬í˜„ë  ë¶€ë¶„
    roomService.joinRoom(request.getRoomId(), 
                        request.getUsername(), 
                        headerAccessor.getSessionId());
}
```

### **3ï¸âƒ£ Redis ì±„ë„ ë™ì  êµ¬ë…**
```java
// RedisListenerConfig.subscribeToRoomChannels() í˜¸ì¶œ
String roomChannel = "stomp:room:room1";
redisMessageListenerContainer.addMessageListener(
    redisStompMessageSubscriber, 
    new ChannelTopic(roomChannel)
);
```

### **4ï¸âƒ£ ë£¸ ìƒíƒœ ì—…ë°ì´íŠ¸**
```java
// Room Serviceì—ì„œ ì°¸ì—¬ì ê´€ë¦¬ (êµ¬í˜„ ì˜ˆì •)
- ë£¸ ì°¸ì—¬ì ëª©ë¡ì— ì‚¬ìš©ì ì¶”ê°€
- ì°¸ì—¬ì ìˆ˜ ì¦ê°€
- ì„¸ì…˜ ID â†” ì‚¬ìš©ì ë§¤í•‘ ì €ì¥
```

### **5ï¸âƒ£ Redisë¡œ ì…ì¥ ë©”ì‹œì§€ ë°œí–‰**
```java
// RedisStompMessagePublisher.publishRoomJoinEvent() í˜¸ì¶œ
RoomMessageDto joinMessage = RoomMessageDto.builder()
    .type(MessageType.JOIN)
    .roomId("room1")
    .sender("ì‚¬ìš©ìA")
    .message("ì‚¬ìš©ìAë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.")
    .participantCount(3)
    .build();

// Redis ì±„ë„ë¡œ ë°œí–‰
redisTemplate.convertAndSend("stomp:room:room1", joinMessage);
```

### **6ï¸âƒ£ Redis ì„œë²„ ë‚´ë¶€ ì „íŒŒ**
```
Redis Server
â”œâ”€â”€ ì±„ë„: stomp:room:room1 
â”œâ”€â”€ ë©”ì‹œì§€: {"type":"JOIN", "sender":"ì‚¬ìš©ìA", ...}
â””â”€â”€ êµ¬ë…ìë“¤: [ì„œë²„1, ì„œë²„2, ì„œë²„3, ...]
```

### **7ï¸âƒ£ Redis Subscriberì—ì„œ ìˆ˜ì‹ **
```java
// RedisStompMessageSubscriber.handleRoomMessage() ìë™ í˜¸ì¶œ
@Override
public void onMessage(Message message, byte[] pattern) {
    String channel = "stomp:room:room1";
    String messageBody = "{"type":"JOIN",...}";
    
    handleRoomMessage(channel, messageBody);
}
```

### **8ï¸âƒ£ STOMP í´ë¼ì´ì–¸íŠ¸ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸**
```java
// ëª¨ë“  êµ¬ë…ìì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
String stompDestination = "/topic/room/room1";
messagingTemplate.convertAndSend(stompDestination, joinMessage);
```

## **ğŸ“Š êµ¬ë… ìƒíƒœ ë³€í™”**

### **ğŸ”´ ì…ì¥ ì „ ìƒíƒœ**
```
// ëª¨ë“  êµ¬ë…ìì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
String stompDestination = "/topic/room/room1";
messagingTemplate.convertAndSend(stompDestination, joinMessage);
```

### **ğŸŸ¢ ì…ì¥ í›„ ìƒíƒœ**
```
í´ë¼ì´ì–¸íŠ¸A: [ë£¸ ì±„ë„ ì¶”ê°€ êµ¬ë…]
â”œâ”€â”€ /topic/session/connect âœ…
â”œâ”€â”€ /topic/session/disconnect âœ…
â”œâ”€â”€ /topic/global âœ…
â”œâ”€â”€ /topic/system/notifications âœ…
â””â”€â”€ /topic/room/room1 ğŸ†• âœ…

Redis ì„œë²„: [ë£¸ ì±„ë„ ë™ì  í™œì„±í™”]  
â”œâ”€â”€ stomp:session:connect âœ…
â”œâ”€â”€ stomp:session:disconnect âœ…
â”œâ”€â”€ stomp:global:broadcast âœ…
â”œâ”€â”€ stomp:system:notifications âœ…
â””â”€â”€ stomp:room:room1 ğŸ†• âœ…
```

## **âš¡ í•µì‹¬ ìµœì í™” í¬ì¸íŠ¸**

### **ğŸ¯ ë™ì  êµ¬ë…ì˜ ì¥ì **
1. **ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„±**: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë£¸ ì±„ë„ì€ êµ¬ë…í•˜ì§€ ì•ŠìŒ
2. **í™•ì¥ì„±**: ìˆ˜ë§Œ ê°œ ë£¸ì´ ìˆì–´ë„ ì°¸ì—¬ ì¤‘ì¸ ë£¸ë§Œ êµ¬ë…
3. **ë„¤íŠ¸ì›Œí¬ ì ˆì•½**: ë¶ˆí•„ìš”í•œ ë©”ì‹œì§€ ìˆ˜ì‹  ë°©ì§€

### **ğŸ“¡ ë¶„ì‚° í™˜ê²½ ì§€ì›**
- **ì„œë²„1**: room1, room2 êµ¬ë…
- **ì„œë²„2**: room1, room3 êµ¬ë…
- **ì„œë²„3**: room2, room4 êµ¬ë…
- ê° ì„œë²„ëŠ” **í•„ìš”í•œ ë£¸ë§Œ êµ¬ë…**í•˜ì—¬ íš¨ìœ¨ì„± ê·¹ëŒ€í™”