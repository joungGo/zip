# Redis Pub/Sub ì¶”ê°€ êµ¬í˜„ ê³„íš
ì™„ë²½í•©ë‹ˆë‹¤! **STOMP + Redis Pub/Sub í•˜ì´ë¸Œë¦¬ë“œ** ë°©ì‹ê³¼ **Lettuce** í´ë¼ì´ì–¸íŠ¸ë¥¼ ë°˜ì˜í•œ ì „ì²´ ì¬êµ¬í˜„ ê³„íšì„ ì œì‹œí•˜ê² ìŠµë‹ˆë‹¤.

## ğŸ¯ STOMP + Redis Pub/Sub í•˜ì´ë¸Œë¦¬ë“œ ì¬êµ¬í˜„ ê³„íš

### ğŸ“‹ Phase 1: ì¸í”„ë¼ ë° ê¸°ë³¸ ì„¤ì •

#### 1.1 ì˜ì¡´ì„± ë° ì„¤ì • ì¶”ê°€
```gradle
// build.gradle ì¶”ê°€ ì˜ì¡´ì„±
implementation 'org.springframework.boot:spring-boot-starter-data-redis'
implementation 'org.springframework.boot:spring-boot-starter-cache'
// LettuceëŠ” Spring Boot ê¸°ë³¸ Redis í´ë¼ì´ì–¸íŠ¸ë¡œ ìë™ í¬í•¨ë¨
```

#### 1.2 Redis ì„¤ì • í´ë˜ìŠ¤ êµ¬í˜„
- **RedisConfig**: Lettuce ê¸°ë°˜ Redis ì—°ê²° ì„¤ì •, RedisTemplate, MessageListenerContainer
- **RedisChannelConfig**: ì±„ë„ íŒ¨í„´ ì •ì˜ ë° ë¦¬ìŠ¤ë„ˆ ë“±ë¡
- **LettuceConnectionFactory**: Lettuce ì»¤ë„¥ì…˜ íŒ©í† ë¦¬ ìµœì í™” ì„¤ì •
- **Redis ì„œë²„ ì„¤ì •**: application.propertiesì— Redis ì—°ê²° ì •ë³´

#### 1.3 STOMP + Redis í†µí•© ì„¤ì •
- **HybridWebSocketConfig**: ê¸°ì¡´ STOMP ì„¤ì • + Redis ë¦¬ìŠ¤ë„ˆ í†µí•©
- **MessageBrokerRelay**: STOMP MessageBrokerì™€ Redis Pub/Sub ë¸Œë¦¿ì§€

### ğŸ“‹ Phase 2: í•˜ì´ë¸Œë¦¬ë“œ ë©”ì‹œì§€ ë¸Œë¡œì»¤ ì•„í‚¤í…ì²˜

#### 2.1 ë©”ì‹œì§€ í”Œë¡œìš° ì„¤ê³„
```
í´ë¼ì´ì–¸íŠ¸ â†” STOMP WebSocket â†” @MessageMapping â†” ë¡œì»¬ ì²˜ë¦¬ â†” Redis Pub/Sub â†” ë‹¤ë¥¸ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë“¤
                                      â†“
                                STOMP Topic ë¸Œë¡œë“œìºìŠ¤íŠ¸ (/topic/room/{roomId})
```

#### 2.2 Redis ì±„ë„ íŒ¨í„´ ì„¤ê³„
```
ì±„ë„ êµ¬ì¡°:
- stomp:broadcast:room:{roomId}      # ë£¸ë³„ STOMP ë©”ì‹œì§€ ë¦´ë ˆì´
- stomp:broadcast:global             # ì „ì—­ STOMP ë¸Œë¡œë“œìºìŠ¤íŠ¸
- stomp:event:join:{roomId}          # ë£¸ ì…ì¥ ì´ë²¤íŠ¸
- stomp:event:leave:{roomId}         # ë£¸ í‡´ì¥ ì´ë²¤íŠ¸
- stomp:session:connect              # ì„¸ì…˜ ì—°ê²° ì´ë²¤íŠ¸
- stomp:session:disconnect           # ì„¸ì…˜ í•´ì œ ì´ë²¤íŠ¸
- stomp:system:notifications         # ì‹œìŠ¤í…œ ì•Œë¦¼
```

#### 2.3 Redis ë©”ì‹œì§€ ë°œí–‰ì(Publisher) êµ¬í˜„
- **RedisStompMessagePublisher**: STOMP ë©”ì‹œì§€ë¥¼ Redisë¡œ ë°œí–‰
- **DistributedMessageSender**: ë¶„ì‚° ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
- **StompMessageSerializer**: STOMP ë©”ì‹œì§€ ì§ë ¬í™”/ì—­ì§ë ¬í™”

#### 2.4 Redis ë©”ì‹œì§€ êµ¬ë…ì(Subscriber) êµ¬í˜„
- **RedisStompMessageSubscriber**: Redis ë©”ì‹œì§€ êµ¬ë… ë° STOMP ì „ë‹¬
- **DistributedEventHandler**: ë¶„ì‚° ì´ë²¤íŠ¸ ì²˜ë¦¬
- **StompMessageRelay**: Redis â†’ STOMP Topic ë¦´ë ˆì´

### ğŸ“‹ Phase 3: STOMP Controller í™•ì¥ ë° Redis í†µí•©

#### 3.1 ê¸°ì¡´ STOMP Controller í™•ì¥
```java
@Controller
public class WebSocketController {
    
    private final ChatRoomService chatRoomService;
    private final RedisStompMessagePublisher redisPublisher;
    
    @MessageMapping("/room/{roomId}/join")
    public void joinRoom(@DestinationVariable String roomId, 
                        @Payload Map<String, String> payload,
                        SimpMessageHeaderAccessor headerAccessor) {
        // 1. ë¡œì»¬ ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        String sessionId = headerAccessor.getSessionId();
        String username = payload.get("username");
        chatRoomService.joinRoom(roomId, sessionId, username);
        
        // 2. Redisë¡œ ë‹¤ë¥¸ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ì— ì „íŒŒ
        redisPublisher.publishJoinEvent(roomId, username, sessionId);
    }
    
    @MessageMapping("/room/{roomId}/message")
    public void sendMessage(@DestinationVariable String roomId,
                           @Payload Map<String, String> payload,
                           SimpMessageHeaderAccessor headerAccessor) {
        // 1. ë¡œì»¬ ì²˜ë¦¬
        String sessionId = headerAccessor.getSessionId();
        String message = payload.get("message");
        RoomMessageDto chatMessage = chatRoomService.sendChatMessage(roomId, sessionId, message);
        
        // 2. Redisë¡œ ë¶„ì‚° ë¸Œë¡œë“œìºìŠ¤íŠ¸
        redisPublisher.publishRoomMessage(roomId, chatMessage);
    }
}
```

#### 3.2 Redis ê¸°ë°˜ ë¶„ì‚° ì„¸ì…˜ ê´€ë¦¬
```
Redis ë°ì´í„° êµ¬ì¡°:
- stomp:sessions:{sessionId}              # ì„¸ì…˜ ì •ë³´ (Hash)
- stomp:sessions:active                   # í™œì„± ì„¸ì…˜ ëª©ë¡ (Set)
- stomp:rooms:{roomId}:participants       # ë£¸ ì°¸ì—¬ì ëª©ë¡ (Set)
- stomp:rooms:{roomId}:info               # ë£¸ ì •ë³´ (Hash)
- stomp:users:{sessionId}:current_room    # ì‚¬ìš©ìë³„ í˜„ì¬ ë£¸ (String)
- stomp:servers:{serverId}:sessions       # ì„œë²„ë³„ ì„¸ì…˜ ëª©ë¡ (Set)
```

### ğŸ“‹ Phase 4: ì„œë¹„ìŠ¤ ë ˆì´ì–´ í•˜ì´ë¸Œë¦¬ë“œ êµ¬í˜„

#### 4.1 ê¸°ì¡´ ì„œë¹„ìŠ¤ Redis í†µí•©
- **HybridChatRoomService**: ê¸°ì¡´ ChatRoomService + Redis ë¶„ì‚° ì²˜ë¦¬
- **HybridWebSocketService**: ê¸°ì¡´ WebSocketService + Redis ì„¸ì…˜ ë™ê¸°í™”
- **RedisSessionSyncService**: ì„œë²„ ê°„ ì„¸ì…˜ ì •ë³´ ë™ê¸°í™”
- **DistributedParticipantService**: ë¶„ì‚° í™˜ê²½ ì°¸ì—¬ì ê´€ë¦¬

#### 4.2 Redis ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ êµ¬í˜„
```java
@Component
public class RedisStompEventListener {
    
    private final SimpMessagingTemplate messagingTemplate;
    
    @EventListener
    public void handleRedisRoomMessage(RedisRoomMessageEvent event) {
        // Redisì—ì„œ ë°›ì€ ë£¸ ë©”ì‹œì§€ë¥¼ STOMPë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        String destination = "/topic/room/" + event.getRoomId();
        messagingTemplate.convertAndSend(destination, event.getMessage());
    }
    
    @EventListener  
    public void handleRedisJoinEvent(RedisJoinEvent event) {
        // ë‹¤ë¥¸ ì„œë²„ì—ì„œ ë°œìƒí•œ ì…ì¥ ì´ë²¤íŠ¸ë¥¼ ë¡œì»¬ STOMPë¡œ ì „ë‹¬
        String destination = "/topic/room/" + event.getRoomId();
        messagingTemplate.convertAndSend(destination, event.getJoinMessage());
    }
}
```

### ğŸ“‹ Phase 5: STOMP ì´ë²¤íŠ¸ì™€ Redis ë™ê¸°í™”

#### 5.1 STOMP ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í™•ì¥
```java
@Component
public class HybridStompEventListener {
    
    private final RedisStompMessagePublisher redisPublisher;
    
    @EventListener
    public void handleWebSocketConnectListener(SessionConnectedEvent event) {
        // ê¸°ì¡´ ë¡œì»¬ ì²˜ë¦¬
        String sessionId = getSessionId(event);
        webSocketService.addSession(sessionId);
        
        // Redisë¡œ ì—°ê²° ì´ë²¤íŠ¸ ì „íŒŒ
        redisPublisher.publishSessionConnectEvent(sessionId);
    }
    
    @EventListener
    public void handleWebSocketDisconnectListener(SessionDisconnectEvent event) {
        // ê¸°ì¡´ ë¡œì»¬ ì •ë¦¬
        String sessionId = getSessionId(event);
        webSocketService.removeSession(sessionId);
        chatRoomService.disconnectSession(sessionId);
        
        // Redisë¡œ í•´ì œ ì´ë²¤íŠ¸ ì „íŒŒ
        redisPublisher.publishSessionDisconnectEvent(sessionId);
    }
}
```

#### 5.2 ë¶„ì‚° ì„¸ì…˜ ë™ê¸°í™”
- **SessionSyncScheduler**: ì£¼ê¸°ì  ì„¸ì…˜ ìƒíƒœ ë™ê¸°í™”
- **CrossServerSessionManager**: ì„œë²„ ê°„ ì„¸ì…˜ ì´ë™ ì²˜ë¦¬
- **SessionFailoverHandler**: ì„œë²„ ì¥ì•  ì‹œ ì„¸ì…˜ ë³µêµ¬

### ğŸ“‹ Phase 6: ê³ ê¸‰ ë¶„ì‚° ê¸°ëŠ¥ êµ¬í˜„

#### 6.1 ë¡œë“œë°¸ëŸ°ì‹± ë° í™•ì¥ì„±
- **ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ë“±ë¡**: Redisì— í™œì„± ì„œë²„ ëª©ë¡ ê´€ë¦¬
- **ì„¸ì…˜ ë¶„ì‚°**: ì„¸ì…˜ affinity ì—†ëŠ” ììœ ë¡œìš´ ì„œë²„ ì´ë™
- **ë™ì  ìŠ¤ì¼€ì¼ë§**: ì„œë²„ ì¶”ê°€/ì œê±° ì‹œ ìë™ ë¦¬ë°¸ëŸ°ì‹±

#### 6.2 Lettuce ì„±ëŠ¥ ìµœì í™”
```java
@Configuration
public class LettuceRedisConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        LettuceClientConfiguration clientConfig = LettuceClientConfiguration.builder()
                .commandTimeout(Duration.ofSeconds(2))
                .shutdownTimeout(Duration.ZERO)
                .build();
        
        return new LettuceConnectionFactory(
            new RedisStandaloneConfiguration("localhost", 6379), 
            clientConfig
        );
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate() {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(redisConnectionFactory());
        template.setDefaultSerializer(new GenericJackson2JsonRedisSerializer());
        return template;
    }
}
```

#### 6.3 ì¥ì•  ë³µêµ¬ ë° ëª¨ë‹ˆí„°ë§
- **Redis Health Check**: Lettuce ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
- **Failover ë©”ì»¤ë‹ˆì¦˜**: Redis ì¥ì•  ì‹œ ë¡œì»¬ ëª¨ë“œ ì „í™˜
- **ë©”íŠ¸ë¦­ ìˆ˜ì§‘**: ë¶„ì‚° ë©”ì‹œì§€ ì²˜ë¦¬ í†µê³„
- **Split-brain ë°©ì§€**: ë„¤íŠ¸ì›Œí¬ ë¶„í•  ì‹œ ì¼ê´€ì„± ë³´ì¥

### ğŸ“‹ Phase 7: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

#### 7.1 í•˜ì´ë¸Œë¦¬ë“œ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
- **ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ í˜¸í™˜ì„±**: HTML í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¬´ë³€ê²½ ë™ì‘
- **ë¶„ì‚° ë£¸ ì±„íŒ…**: ì—¬ëŸ¬ ì„œë²„ì—ì„œ ë™ì¼ ë£¸ ì°¸ì—¬ í…ŒìŠ¤íŠ¸
- **ì„œë²„ ê°„ ë©”ì‹œì§€ ë™ê¸°í™”**: ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „íŒŒ ê²€ì¦

#### 7.2 ë¶„ì‚° í™˜ê²½ í…ŒìŠ¤íŠ¸
- **ë‹¤ì¤‘ ì„œë²„ ë°°í¬**: 2ê°œ ì´ìƒ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ë™ì‹œ ì‹¤í–‰
- **ì„¸ì…˜ ì´ë™**: ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•œ ì„œë²„ ê°„ ìš”ì²­ ë¶„ì‚°
- **ì¥ì•  ë³µêµ¬**: Redis ì„œë²„ ë‹¤ìš´/ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤

## ğŸ”§ í•µì‹¬ ì•„í‚¤í…ì²˜ ë³€ê²½ì 

### 1. **ë©”ì‹œì§€ í”Œë¡œìš°**
```
ê¸°ì¡´: í´ë¼ì´ì–¸íŠ¸ â†” STOMP â†” Spring MessageBroker (ë‹¨ì¼ ì„œë²„)
ë³€ê²½: í´ë¼ì´ì–¸íŠ¸ â†” STOMP â†” Spring MessageBroker â†” Redis Pub/Sub â†” ë¶„ì‚° ì„œë²„ë“¤
```

### 2. **STOMP ì–´ë…¸í…Œì´ì…˜ ìœ ì§€**
- **@MessageMapping**: ê¸°ì¡´ ë¼ìš°íŒ… ë¡œì§ ì™„ì „ ë³´ì¡´
- **@SendTo**: ë¡œì»¬ STOMP ë¸Œë¡œë“œìºìŠ¤íŠ¸ + Redis ë¶„ì‚° ì „íŒŒ
- **SimpMessagingTemplate**: STOMP ë©”ì‹œì§€ ì „ì†¡ ë°©ì‹ ìœ ì§€

### 3. **ì´ì¤‘í™”ëœ ìƒíƒœ ê´€ë¦¬**
- **ë¡œì»¬ ë©”ëª¨ë¦¬**: ë¹ ë¥¸ ì‘ë‹µì„ ìœ„í•œ ìºì‹œ ì—­í• 
- **Redis**: ë¶„ì‚° í™˜ê²½ ë™ê¸°í™” ë° ì˜ì†ì„±

### 4. **í´ë¼ì´ì–¸íŠ¸ íˆ¬ëª…ì„±**
- **ê¸°ì¡´ JavaScript ì½”ë“œ ë¬´ë³€ê²½**: STOMP.js ê·¸ëŒ€ë¡œ ì‚¬ìš©
- **ë™ì¼í•œ ì—”ë“œí¬ì¸íŠ¸**: `/ws` WebSocket ì—°ê²° ìœ ì§€
- **ê°™ì€ Topic êµ¬ì¡°**: `/topic/room/{roomId}` êµ¬ë… ë°©ì‹ ìœ ì§€

## ğŸš€ ì˜ˆìƒ íš¨ê³¼

### **í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ì˜ ì¥ì **
1. **ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜**: ê¸°ì¡´ ì½”ë“œ ë³´ì¡´í•˜ë©° ë¶„ì‚° ê¸°ëŠ¥ ì¶”ê°€
2. **ê°œë°œ ìƒì‚°ì„±**: STOMPì˜ êµ¬ì¡°í™”ëœ ê°œë°œ ê²½í—˜ ìœ ì§€
3. **ì„±ëŠ¥ ìµœì í™”**: ë¡œì»¬ ìºì‹œ + Redis ë¶„ì‚° ì²˜ë¦¬
4. **ì¥ì•  ë³µêµ¬**: Redis ì¥ì•  ì‹œì—ë„ ë‹¨ì¼ ì„œë²„ ëª¨ë“œë¡œ ë™ì‘ ê°€ëŠ¥

### **Lettuce ì‚¬ìš©ì˜ ì´ì **
1. **Spring Boot ê¸°ë³¸ ì§€ì›**: ë³„ë„ ì„¤ì • ìµœì†Œí™”
2. **ë¹„ë™ê¸° ì²˜ë¦¬**: Non-blocking I/Oë¡œ ë†’ì€ ì„±ëŠ¥
3. **Connection Pooling**: ìë™ ì—°ê²° ê´€ë¦¬ ë° ìµœì í™”
4. **Reactive ì§€ì›**: Spring WebFluxì™€ì˜ í˜¸í™˜ì„±